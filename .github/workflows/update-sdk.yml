name: Update SDK

on:
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 06:00 UTC
  workflow_dispatch: # Allow manual trigger

env:
  GOMAXPROCS: 2
  OPEN_API_SPEC: https://api.omnistrate.cloud/2022-09-01-00/openapi.yaml
  FLEET_OPEN_API_SPEC: https://api.omnistrate.cloud/2022-09-01-00/fleet/openapi.yaml

permissions:
  contents: write
  pull-requests: write

jobs:
  update-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v4

      - name: Set up Go
        timeout-minutes: 10
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v5
        with:
          go-version-file: 'go.mod'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install OpenAPI Generator
        run: |
          npm install @openapitools/openapi-generator-cli -g

      - name: Download OpenAPI specs
        id: specs
        run: |
          mkdir -p /tmp/specs
          curl -sSfL "$OPEN_API_SPEC" -o /tmp/specs/v1.yaml
          curl -sSfL "$FLEET_OPEN_API_SPEC" -o /tmp/specs/fleet.yaml

          V1_HASH=$(sha256sum /tmp/specs/v1.yaml | cut -d' ' -f1)
          FLEET_HASH=$(sha256sum /tmp/specs/fleet.yaml | cut -d' ' -f1)
          echo "v1_hash=${V1_HASH}" >> "$GITHUB_OUTPUT"
          echo "fleet_hash=${FLEET_HASH}" >> "$GITHUB_OUTPUT"

      - name: Regenerate SDK
        run: |
          make clean
          make gen-go-sdk OPEN_API_SPEC=/tmp/specs/v1.yaml
          make gen-fleet-go-sdk FLEET_OPEN_API_SPEC=/tmp/specs/fleet.yaml
          make tidy

      - name: Build
        timeout-minutes: 10
        run: make build

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No SDK changes detected."
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"

            ADDED=$(git diff --numstat | awk '{a+=$1}END{print a+0}')
            REMOVED=$(git diff --numstat | awk '{a+=$2}END{print a+0}')
            FILES=$(git diff --name-only | wc -l | tr -d ' ')
            echo "added=$ADDED" >> "$GITHUB_OUTPUT"
            echo "removed=$REMOVED" >> "$GITHUB_OUTPUT"
            echo "files=$FILES" >> "$GITHUB_OUTPUT"

            echo "### Changed files summary" >> "$GITHUB_STEP_SUMMARY"
            echo "- Files changed: $FILES" >> "$GITHUB_STEP_SUMMARY"
            echo "- Lines added: $ADDED" >> "$GITHUB_STEP_SUMMARY"
            echo "- Lines removed: $REMOVED" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update generated SDK from latest OpenAPI specs

            v1 spec hash: ${{ steps.specs.outputs.v1_hash }}
            fleet spec hash: ${{ steps.specs.outputs.fleet_hash }}
          branch: auto/update-sdk
          delete-branch: true
          title: 'chore: update generated SDK from latest OpenAPI specs'
          body: |
            ## Automated SDK Update

            This PR was automatically generated by the **Update SDK** workflow.

            ### What changed
            The SDK was regenerated from the latest Omnistrate OpenAPI specifications:
            - **v1 spec**: `${{ env.OPEN_API_SPEC }}`
            - **Fleet spec**: `${{ env.FLEET_OPEN_API_SPEC }}`

            ### Stats
            - **Files changed**: ${{ steps.changes.outputs.files }}
            - **Lines added**: ${{ steps.changes.outputs.added }}
            - **Lines removed**: ${{ steps.changes.outputs.removed }}

            ### Spec hashes
            | Spec | SHA-256 |
            |------|---------|
            | v1 | `${{ steps.specs.outputs.v1_hash }}` |
            | fleet | `${{ steps.specs.outputs.fleet_hash }}` |

            ### Validation
            - ✅ SDK regenerated successfully
            - ✅ `go build` passed
          labels: |
            automated
            sdk-update
